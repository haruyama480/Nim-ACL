---
data:
  _extendedDependsOn:
  - icon: ':question:'
    path: atcoder/element_concepts.nim
    title: atcoder/element_concepts.nim
  - icon: ':question:'
    path: atcoder/element_concepts.nim
    title: atcoder/element_concepts.nim
  - icon: ':question:'
    path: atcoder/generate_definitions.nim
    title: atcoder/generate_definitions.nim
  - icon: ':question:'
    path: atcoder/generate_definitions.nim
    title: atcoder/generate_definitions.nim
  - icon: ':question:'
    path: atcoder/internal_bit.nim
    title: atcoder/internal_bit.nim
  - icon: ':question:'
    path: atcoder/internal_bit.nim
    title: atcoder/internal_bit.nim
  - icon: ':question:'
    path: atcoder/internal_math.nim
    title: atcoder/internal_math.nim
  - icon: ':question:'
    path: atcoder/internal_math.nim
    title: atcoder/internal_math.nim
  - icon: ':question:'
    path: atcoder/modint.nim
    title: atcoder/modint.nim
  - icon: ':question:'
    path: atcoder/modint.nim
    title: atcoder/modint.nim
  _extendedRequiredBy:
  - icon: ':x:'
    path: atcoder/extra/math/arbitrary_mod_convolution.nim
    title: atcoder/extra/math/arbitrary_mod_convolution.nim
  - icon: ':x:'
    path: atcoder/extra/math/arbitrary_mod_convolution.nim
    title: atcoder/extra/math/arbitrary_mod_convolution.nim
  - icon: ':x:'
    path: atcoder/extra/math/composition.nim
    title: atcoder/extra/math/composition.nim
  - icon: ':x:'
    path: atcoder/extra/math/composition.nim
    title: atcoder/extra/math/composition.nim
  - icon: ':x:'
    path: atcoder/extra/math/ntt.nim
    title: atcoder/extra/math/ntt.nim
  - icon: ':x:'
    path: atcoder/extra/math/ntt.nim
    title: atcoder/extra/math/ntt.nim
  - icon: ':x:'
    path: atcoder/extra/math/particular_mod_convolution.nim
    title: atcoder/extra/math/particular_mod_convolution.nim
  - icon: ':x:'
    path: atcoder/extra/math/particular_mod_convolution.nim
    title: atcoder/extra/math/particular_mod_convolution.nim
  - icon: ':warning:'
    path: test/example/convolution_int_practice.nim
    title: test/example/convolution_int_practice.nim
  - icon: ':warning:'
    path: test/example/convolution_int_practice.nim
    title: test/example/convolution_int_practice.nim
  - icon: ':warning:'
    path: test/example/convolution_practice.nim
    title: test/example/convolution_practice.nim
  - icon: ':warning:'
    path: test/example/convolution_practice.nim
    title: test/example/convolution_practice.nim
  - icon: ':warning:'
    path: tests/test_convolution.nim
    title: tests/test_convolution.nim
  - icon: ':warning:'
    path: tests/test_convolution.nim
    title: tests/test_convolution.nim
  - icon: ':warning:'
    path: tests/test_extra_formal_power_series.nim
    title: tests/test_extra_formal_power_series.nim
  - icon: ':warning:'
    path: tests/test_extra_formal_power_series.nim
    title: tests/test_extra_formal_power_series.nim
  _extendedVerifiedWith:
  - icon: ':heavy_check_mark:'
    path: verify/convolution_test.nim
    title: verify/convolution_test.nim
  - icon: ':heavy_check_mark:'
    path: verify/convolution_test.nim
    title: verify/convolution_test.nim
  - icon: ':heavy_check_mark:'
    path: verify/extra/graph/centroid_decomposition_test.nim
    title: verify/extra/graph/centroid_decomposition_test.nim
  - icon: ':heavy_check_mark:'
    path: verify/extra/graph/centroid_decomposition_test.nim
    title: verify/extra/graph/centroid_decomposition_test.nim
  - icon: ':x:'
    path: verify/extra/math/arbitrary_mod_convolution_test.nim
    title: verify/extra/math/arbitrary_mod_convolution_test.nim
  - icon: ':x:'
    path: verify/extra/math/arbitrary_mod_convolution_test.nim
    title: verify/extra/math/arbitrary_mod_convolution_test.nim
  - icon: ':x:'
    path: verify/extra/math/arbitrary_mod_exp_modsqrt_test.nim
    title: verify/extra/math/arbitrary_mod_exp_modsqrt_test.nim
  - icon: ':x:'
    path: verify/extra/math/arbitrary_mod_exp_modsqrt_test.nim
    title: verify/extra/math/arbitrary_mod_exp_modsqrt_test.nim
  - icon: ':x:'
    path: verify/extra/math/convolution_montgomery_test.nim
    title: verify/extra/math/convolution_montgomery_test.nim
  - icon: ':x:'
    path: verify/extra/math/convolution_montgomery_test.nim
    title: verify/extra/math/convolution_montgomery_test.nim
  - icon: ':x:'
    path: verify/extra/math/exp_of_formal_power_series_test.nim
    title: verify/extra/math/exp_of_formal_power_series_test.nim
  - icon: ':x:'
    path: verify/extra/math/exp_of_formal_power_series_test.nim
    title: verify/extra/math/exp_of_formal_power_series_test.nim
  - icon: ':x:'
    path: verify/extra/math/inv_of_formal_power_series_test.nim
    title: verify/extra/math/inv_of_formal_power_series_test.nim
  - icon: ':x:'
    path: verify/extra/math/inv_of_formal_power_series_test.nim
    title: verify/extra/math/inv_of_formal_power_series_test.nim
  - icon: ':x:'
    path: verify/extra/math/log_of_formal_power_series_test.nim
    title: verify/extra/math/log_of_formal_power_series_test.nim
  - icon: ':x:'
    path: verify/extra/math/log_of_formal_power_series_test.nim
    title: verify/extra/math/log_of_formal_power_series_test.nim
  - icon: ':x:'
    path: verify/extra/math/pow_of_formal_power_series_test.nim
    title: verify/extra/math/pow_of_formal_power_series_test.nim
  - icon: ':x:'
    path: verify/extra/math/pow_of_formal_power_series_test.nim
    title: verify/extra/math/pow_of_formal_power_series_test.nim
  - icon: ':x:'
    path: verify/extra/math/sqrt_of_formal_power_series_test.nim
    title: verify/extra/math/sqrt_of_formal_power_series_test.nim
  - icon: ':x:'
    path: verify/extra/math/sqrt_of_formal_power_series_test.nim
    title: verify/extra/math/sqrt_of_formal_power_series_test.nim
  - icon: ':x:'
    path: verify/extra/math/yosupo_composition_of_formal_power_series_test.nim
    title: verify/extra/math/yosupo_composition_of_formal_power_series_test.nim
  - icon: ':x:'
    path: verify/extra/math/yosupo_composition_of_formal_power_series_test.nim
    title: verify/extra/math/yosupo_composition_of_formal_power_series_test.nim
  - icon: ':x:'
    path: verify/extra/math/yosupo_sharp_p_subset_sum_test.nim
    title: verify/extra/math/yosupo_sharp_p_subset_sum_test.nim
  - icon: ':x:'
    path: verify/extra/math/yosupo_sharp_p_subset_sum_test.nim
    title: verify/extra/math/yosupo_sharp_p_subset_sum_test.nim
  - icon: ':x:'
    path: verify/extra/math/yukicoder_factorial_test.nim
    title: verify/extra/math/yukicoder_factorial_test.nim
  - icon: ':x:'
    path: verify/extra/math/yukicoder_factorial_test.nim
    title: verify/extra/math/yukicoder_factorial_test.nim
  _isVerificationFailed: true
  _pathExtension: nim
  _verificationStatusIcon: ':question:'
  attributes:
    links: []
  bundledCode: "Traceback (most recent call last):\n  File \"/opt/hostedtoolcache/Python/3.9.6/x64/lib/python3.9/site-packages/onlinejudge_verify/documentation/build.py\"\
    , line 71, in _render_source_code_stat\n    bundled_code = language.bundle(stat.path,\
    \ basedir=basedir, options={'include_paths': [basedir]}).decode()\n  File \"/opt/hostedtoolcache/Python/3.9.6/x64/lib/python3.9/site-packages/onlinejudge_verify/languages/nim.py\"\
    , line 86, in bundle\n    raise NotImplementedError\nNotImplementedError\n"
  code: "when not declared ATCODER_CONVOLUTION_HPP:\n  const ATCODER_CONVOLUTION_HPP*\
    \ = 1\n\n  import std/math, std/sequtils, std/sugar\n  import atcoder/internal_math,\
    \ atcoder/internal_bit\n  import atcoder/element_concepts\n\n#  template <class\
    \ mint, internal::is_static_modint_t<mint>* = nullptr>\n  proc butterfly*[mint:FiniteFieldElem](a:var\
    \ seq[mint]) =\n    const g = primitive_root[mint.mod]()\n    let\n      n = a.len\n\
    \      h = ceil_pow2(n)\n    var\n      first {.global.} = true\n      sum_e {.global.}\
    \ :array[30, mint]   # sum_e[i] = ies[0] * ... * ies[i - 1] * es[i]\n    if first:\n\
    \      first = false\n      var es, ies:array[30, mint] # es[i]^(2^(2+i)) == 1\n\
    \      let cnt2 = bsf(mint.mod - 1)\n      mixin inv, init\n      var\n      \
    \  e = mint.init(g).pow((mint.mod - 1) shr cnt2)\n        ie = e.inv()\n     \
    \ for i in countdown(cnt2, 2):\n        # e^(2^i) == 1\n        es[i - 2] = e\n\
    \        ies[i - 2] = ie\n        e *= e\n        ie *= ie\n      var now = mint.init(1)\n\
    \      for i in 0..cnt2 - 2:\n        sum_e[i] = es[i] * now\n        now *= ies[i]\n\
    \    for ph in 1..h:\n      let\n        w = 1 shl (ph - 1)\n        p = 1 shl\
    \ (h - ph)\n      var now = mint.init(1)\n      for s in 0..<w:\n        let offset\
    \ = s shl (h - ph + 1)\n        for i in 0..<p:\n          let\n            l\
    \ = a[i + offset]\n            r = a[i + offset + p] * now\n          a[i + offset]\
    \ = l + r\n          a[i + offset + p] = l - r\n        now *= sum_e[bsf(not s)]\n\
    \  \n  proc butterfly_inv*[mint:FiniteFieldElem](a:var seq[mint]) =\n    const\
    \ g = primitive_root[mint.mod]()\n    let\n      n = a.len\n      h = ceil_pow2(n)\n\
    \    var\n      first{.global.} = true\n      sum_ie{.global.}:array[30, mint]\
    \  # sum_ie[i] = es[0] * ... * es[i - 1] * ies[i]\n    mixin inv, init\n    if\
    \ first:\n      first = false\n      var es, ies: array[30, mint] # es[i]^(2^(2+i))\
    \ == 1\n      let cnt2 = bsf(mint.mod - 1)\n      var\n        e = mint.init(g).pow((mint.mod\
    \ - 1) shr cnt2)\n        ie = e.inv()\n      for i in countdown(cnt2, 2):\n \
    \       # e^(2^i) == 1\n        es[i - 2] = e\n        ies[i - 2] = ie\n     \
    \   e *= e\n        ie *= ie\n      var now = mint.init(1)\n      for i in 0..cnt2\
    \ - 2:\n        sum_ie[i] = ies[i] * now\n        now *= es[i]\n    for ph in\
    \ countdown(h, 1):\n      let\n        w = 1 shl (ph - 1)\n        p = 1 shl (h\
    \ - ph)\n      var inow = mint.init(1)\n      for s in 0..<w:\n        let offset\
    \ = s shl (h - ph + 1)\n        for i in 0..<p:\n          let\n            l\
    \ = a[i + offset]\n            r = a[i + offset + p]\n          a[i + offset]\
    \ = l + r\n          a[i + offset + p] = mint.init((mint.mod + l.val - r.val)\
    \ * inow.val)\n        inow *= sum_ie[bsf(not s)]\n\n#  template <class mint,\
    \ internal::is_static_modint_t<mint>* = nullptr>\n  proc convolution*[mint:FiniteFieldElem](a,\
    \ b:seq[mint]):seq[mint] =\n    var\n      n = a.len\n      m = b.len\n    mixin\
    \ inv, init\n    if n == 0 or m == 0: return newSeq[mint]()\n    var (a, b) =\
    \ (a, b)\n    if min(n, m) <= 60:\n      if n < m:\n        swap(n, m)\n     \
    \   swap(a, b)\n      var ans = newSeq[mint](n + m - 1)\n      for i in 0..<n:\n\
    \        for j in 0..<m:\n          ans[i + j] += a[i] * b[j]\n      return ans\n\
    \    let z = 1 shl ceil_pow2(n + m - 1)\n    a.setlen(z)\n    butterfly(a)\n \
    \   b.setlen(z)\n    butterfly(b)\n    for i in 0..<z:\n      a[i] *= b[i]\n \
    \   butterfly_inv(a)\n    a.setlen(n + m - 1)\n    let iz = mint.init(z).inv()\n\
    \    for i in 0..<n+m-1: a[i] *= iz\n    return a\n\n\n  import atcoder/modint\n\
    #  template <unsigned int mod = 998244353,\n#      class T,\n#      std::enable_if_t<internal::is_integral<T>::value>*\
    \ = nullptr>\n  proc convolution*[T:SomeInteger](a, b:seq[T], M:static[uint] =\
    \ 998244353):seq[T] =\n    let (n, m) = (a.len, b.len)\n    if n == 0 or m ==\
    \ 0: return newSeq[T]()\n  \n    type mint = StaticModInt[M.int]\n    static:\n\
    \      assert mint is FiniteFieldElem\n    return convolution(\n      a.map((x:T)\
    \ => mint.init(x)), \n      b.map((x:T) => mint.init(x))\n    ).map((x:mint) =>\
    \ T(x.val()))\n\n  proc convolution_ll*(a, b:seq[int]):seq[int] =\n    let (n,\
    \ m) = (a.len, b.len)\n    if n == 0 or m == 0: return newSeq[int]()\n    const\n\
    \      MOD1:uint = 754974721  # 2^24\n      MOD2:uint = 167772161  # 2^25\n  \
    \    MOD3:uint = 469762049  # 2^26\n      M2M3 = MOD2 * MOD3\n      M1M3 = MOD1\
    \ * MOD3\n      M1M2 = MOD1 * MOD2\n      M1M2M3 = MOD1 * MOD2 * MOD3\n\n    \
    \  i1 = inv_gcd((MOD2 * MOD3).int, MOD1.int)[1].uint\n      i2 = inv_gcd((MOD1\
    \ * MOD3).int, MOD2.int)[1].uint\n      i3 = inv_gcd((MOD1 * MOD2).int, MOD3.int)[1].uint\n\
    \    \n    let\n      c1 = convolution(a, b, MOD1)\n      c2 = convolution(a,\
    \ b, MOD2)\n      c3 = convolution(a, b, MOD3)\n  \n    var c = newSeq[int](n\
    \ + m - 1)\n    for i in 0..<n + m - 1:\n      var x = 0.uint\n      x += (c1[i].uint\
    \ * i1) mod MOD1 * M2M3\n      x += (c2[i].uint * i2) mod MOD2 * M1M3\n      x\
    \ += (c3[i].uint * i3) mod MOD3 * M1M2\n      # B = 2^63, -B <= x, r(real value)\
    \ < B\n      # (x, x - M, x - 2M, or x - 3M) = r (mod 2B)\n      # r = c1[i] (mod\
    \ MOD1)\n      # focus on MOD1\n      # r = x, x - M', x - 2M', x - 3M' (M' =\
    \ M % 2^64) (mod 2B)\n      # r = x,\n      #   x - M' + (0 or 2B),\n      # \
    \  x - 2M' + (0, 2B or 4B),\n      #   x - 3M' + (0, 2B, 4B or 6B) (without mod!)\n\
    \      # (r - x) = 0, (0)\n      #       - M' + (0 or 2B), (1)\n      #      \
    \ -2M' + (0 or 2B or 4B), (2)\n      #       -3M' + (0 or 2B or 4B or 6B) (3)\
    \ (mod MOD1)\n      # we checked that\n      #   ((1) mod MOD1) mod 5 = 2\n  \
    \    #   ((2) mod MOD1) mod 5 = 3\n      #   ((3) mod MOD1) mod 5 = 4\n      var\
    \ diff = c1[i] - floorMod(x.int, MOD1.int)\n      if diff < 0: diff += MOD1.int\n\
    \      const offset = [0'u, 0'u, M1M2M3, 2'u * M1M2M3, 3'u * M1M2M3]\n      x\
    \ -= offset[diff mod 5]\n      c[i] = x.int\n    return c\n"
  dependsOn:
  - atcoder/element_concepts.nim
  - atcoder/internal_bit.nim
  - atcoder/modint.nim
  - atcoder/element_concepts.nim
  - atcoder/internal_bit.nim
  - atcoder/modint.nim
  - atcoder/internal_math.nim
  - atcoder/internal_math.nim
  - atcoder/generate_definitions.nim
  - atcoder/generate_definitions.nim
  isVerificationFile: false
  path: atcoder/convolution.nim
  requiredBy:
  - tests/test_convolution.nim
  - tests/test_convolution.nim
  - tests/test_extra_formal_power_series.nim
  - tests/test_extra_formal_power_series.nim
  - atcoder/extra/math/composition.nim
  - atcoder/extra/math/composition.nim
  - atcoder/extra/math/ntt.nim
  - atcoder/extra/math/ntt.nim
  - atcoder/extra/math/arbitrary_mod_convolution.nim
  - atcoder/extra/math/arbitrary_mod_convolution.nim
  - atcoder/extra/math/particular_mod_convolution.nim
  - atcoder/extra/math/particular_mod_convolution.nim
  - test/example/convolution_practice.nim
  - test/example/convolution_practice.nim
  - test/example/convolution_int_practice.nim
  - test/example/convolution_int_practice.nim
  timestamp: '1970-01-01 00:00:00+00:00'
  verificationStatus: LIBRARY_SOME_WA
  verifiedWith:
  - verify/convolution_test.nim
  - verify/convolution_test.nim
  - verify/extra/graph/centroid_decomposition_test.nim
  - verify/extra/graph/centroid_decomposition_test.nim
  - verify/extra/math/yukicoder_factorial_test.nim
  - verify/extra/math/yukicoder_factorial_test.nim
  - verify/extra/math/exp_of_formal_power_series_test.nim
  - verify/extra/math/exp_of_formal_power_series_test.nim
  - verify/extra/math/convolution_montgomery_test.nim
  - verify/extra/math/convolution_montgomery_test.nim
  - verify/extra/math/yosupo_sharp_p_subset_sum_test.nim
  - verify/extra/math/yosupo_sharp_p_subset_sum_test.nim
  - verify/extra/math/log_of_formal_power_series_test.nim
  - verify/extra/math/log_of_formal_power_series_test.nim
  - verify/extra/math/sqrt_of_formal_power_series_test.nim
  - verify/extra/math/sqrt_of_formal_power_series_test.nim
  - verify/extra/math/yosupo_composition_of_formal_power_series_test.nim
  - verify/extra/math/yosupo_composition_of_formal_power_series_test.nim
  - verify/extra/math/inv_of_formal_power_series_test.nim
  - verify/extra/math/inv_of_formal_power_series_test.nim
  - verify/extra/math/arbitrary_mod_exp_modsqrt_test.nim
  - verify/extra/math/arbitrary_mod_exp_modsqrt_test.nim
  - verify/extra/math/pow_of_formal_power_series_test.nim
  - verify/extra/math/pow_of_formal_power_series_test.nim
  - verify/extra/math/arbitrary_mod_convolution_test.nim
  - verify/extra/math/arbitrary_mod_convolution_test.nim
documentation_of: atcoder/convolution.nim
layout: document
redirect_from:
- /library/atcoder/convolution.nim
- /library/atcoder/convolution.nim.html
title: atcoder/convolution.nim
---
